version: '3.9'

services:
  # Cobalt API Backend
  cobalt-api:
    image: ghcr.io/imputnet/cobalt:latest
    container_name: cobalt-api
    init: true
    read_only: true
    restart: unless-stopped
    ports:
      - "127.0.0.1:5001:9000"
    environment:
      API_URL: ${API_URL:-https://taivideo.websites.com.vn}
      # YouTube cookies for bypassing bot detection (Option C)
      COOKIE_PATH: "/cookies.json"
      # YouTube session generator (Option A - currently disabled due to VPS IP blocking)
      # YOUTUBE_SESSION_SERVER: http://yt-session:8080/
      # Thêm các biến môi trường khác nếu cần
      # TURNSTILE_SITEKEY: ""
      # TURNSTILE_SECRET: ""
    volumes:
      - ./cookies.json:/cookies.json:ro
    # depends_on:
    #   yt-session:
    #     condition: service_healthy
    labels:
      - com.centurylinklabs.watchtower.scope=cobalt
    networks:
      - cobalt-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # YouTube Session Generator - Option A (Disabled - not working on this VPS)
  # Reason: VPS IP is blocked by YouTube, causing timeout errors
  # Using Option C (cookies.json) instead
  # yt-session:
  #   image: ghcr.io/imputnet/yt-session-generator:webserver
  #   container_name: yt-session-generator
  #   init: true
  #   restart: unless-stopped
  #   cap_add:
  #     - SYS_ADMIN
  #   environment:
  #     NO_SANDBOX: "true"
  #   networks:
  #     - cobalt-network
  #   labels:
  #     - com.centurylinklabs.watchtower.scope=cobalt
  #   healthcheck:
  #     test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:8080/"]
  #     interval: 60s
  #     timeout: 10s
  #     retries: 5
  #     start_period: 180s

  # Web Interface Frontend
  cobalt-web:
    build:
      context: ./web-interface
      dockerfile: Dockerfile
    container_name: cobalt-web
    restart: unless-stopped
    ports:
      - "127.0.0.1:5002:80"
    environment:
      NGINX_HOST: ${WEB_DOMAIN:-download.websites.com.vn}
      NGINX_PORT: 80
      API_ENDPOINT: ${API_URL:-https://taivideo.websites.com.vn}
    depends_on:
      cobalt-api:
        condition: service_healthy
    labels:
      - com.centurylinklabs.watchtower.scope=cobalt
    networks:
      - cobalt-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # YouTube yt-dlp Handler - Custom YouTube downloader (bypass Cobalt)
  ytdlp-service:
    build:
      context: ./ytdlp-service
      dockerfile: Dockerfile
    container_name: ytdlp-youtube-handler
    restart: unless-stopped
    ports:
      - "127.0.0.1:5003:5003"
    volumes:
      - ./ytdlp-service/cookies.txt:/app/cookies.txt
    networks:
      - cobalt-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # Watchtower - Auto update containers
  watchtower:
    image: ghcr.io/containrrr/watchtower
    container_name: cobalt-watchtower
    restart: unless-stopped
    command: --cleanup --scope cobalt --interval 900 --include-restarting
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    labels:
      - com.centurylinklabs.watchtower.scope=cobalt
    networks:
      - cobalt-network

networks:
  cobalt-network:
    driver: bridge
    name: cobalt-network
